<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job Card / Route Card - Cloud App (PWA) with Full Access</title>
  
  <link rel="manifest" href="manifest.json">
  
  <script>
    // üîí SECURITY Enhancement: Disable Right Click and Developer Tools Access
    document.addEventListener('contextmenu', event => event.preventDefault()); // Right Click Disable
    document.onkeydown = function(e) {
        // F12 (123) ‡§î‡§∞ Ctrl+Shift+I/C/J/K ‡§ï‡•ã ‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J' || e.key === 'K'))) {
            return false;
        }
        // Ctrl+U (View Source) ‡§ï‡•ã ‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
        if (e.ctrlKey && e.key === 'u') {
            return false;
        }
    };
  </script>
  
  <script type="module">
        // --- FIREBASE CONFIGURATION ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAaQoa6pSF7ZEPne6BYT8V7l6OslHPTYjw",
            authDomain: "jobcard-app-7b99c.firebaseapp.com",
            projectId: "jobcard-app-7b99c",
            storageBucket: "jobcard-app-7b99c.firebasestorage.app",
            messagingSenderId: "36117182109",
            appId: "1:36117182109:web:3007d2193063100d3c4674"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app); 

        // üõë RBAC REMOVED: Assume full access for any logged-in user
        let currentUserRole = 'admin'; 
        let currentView = 'home'; 

        // --- Full Access Control Function (SIMPLIFIED) ---
        // üõ†Ô∏è FIX: Defining globally to resolve 'is not defined' error.
        window.updateActionButtons = function(reportData) {
            // FIX: Check if we have a valid uniqueId that is not a temporary NEW_ one.
            const isReportLoaded = reportData && reportData.uniqueId && !reportData.uniqueId.startsWith('NEW_');
            const isCompleted = document.getElementById('statusField')?.value === 'Completed';
            
            // üîì All actions enabled for logged-in users (since role is 'admin' or logged_out)
            const isLoggedIn = currentUserRole !== 'logged_out';

            document.getElementById('saveReport').disabled = !isLoggedIn;
            document.getElementById('deleteReport').disabled = !(isLoggedIn && isReportLoaded);
            document.getElementById('completeReportBtn').disabled = !(isReportLoaded && isLoggedIn && !isCompleted);
            // document.getElementById('sendReportBtn').disabled = !(isLoggedIn && isReportLoaded); // REMOVED: Send Report Button

            // FORM Inputs: All inputs enabled if logged in
            document.querySelectorAll('.form input, .form select, .form button:not(#loginButton, #signUpButton, #logoutButton, #homeViewBtn, #formViewBtn, #newJobFromHome)').forEach(el => {
                el.disabled = !isLoggedIn;
            });

            document.getElementById('applyBtn').disabled = !isLoggedIn;
            document.getElementById('updateOpsBtn').disabled = !isLoggedIn;

            // FIX: Check reportData.uniqueId for display
            document.getElementById('currentReportId').textContent = `Active ID: ${reportData && reportData.uniqueId ? (reportData.uniqueId.startsWith('NEW') ? '-- New --' : reportData.uniqueId) : '-- New --'}`;
            
            if (isReportLoaded && isLoggedIn) {
                document.getElementById('saveReport').textContent = 'üíæ Update Report';
            } else if (isLoggedIn) {
                document.getElementById('saveReport').textContent = 'üíæ Save New Report';
            } else {
                 document.getElementById('saveReport').textContent = '‚ö†Ô∏è Log In to Save';
            }
        };

        // --- AUTHENTICATION & CLOUD FUNCTIONS ---
        window.handleAuthAction = async (actionType) => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (actionType !== 'logout' && (!email || !password)) {
                alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç‡•§");
                return;
            }

            try {
                if (actionType === 'signup') {
                    // Simplified: Just create user in Auth, no Firestore doc needed now
                    await createUserWithEmailAndPassword(window.auth, email, password);
                    alert(`‚úÖ Signed Up and Logged In as ${email}. Full access enabled.`);
                } else if (actionType === 'signin') {
                    await signInWithEmailAndPassword(window.auth, email, password);
                    alert(`‚úÖ Signed In as ${email}.`);
                } else if (actionType === 'logout') {
                    await signOut(window.auth);
                    alert("üëã Logged Out successfully!");
                }
            } catch (error) {
                alert(`‚ùå Auth Failed: ${error.message}`);
            }
        };

        window.updateAuthUI = async (user) => {
            const loggedOutUI = document.getElementById('loggedOutUI');
            const loggedInUI = document.getElementById('loggedInUI');
            const authStatus = document.getElementById('authStatus');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            
            if (user) {
                loggedOutUI.style.display = 'none';
                loggedInUI.style.display = 'flex';
                
                // üõë RBAC REMOVED: Set role to 'admin' (full access) if logged in
                currentUserRole = 'admin'; 
                userEmailDisplay.textContent = `User: ${user.email} | Role: FULL ACCESS`;
                
                authStatus.textContent = `Status: Logged In (Cloud Active)`;
                authStatus.style.color = '#059669';
                
                showView('home');
                
            } else {
                // Logged Out State
                loggedOutUI.style.display = 'flex';
                loggedInUI.style.display = 'none';
                authStatus.textContent = "Status: Logged Out (Cloud Disabled)";
                authStatus.style.color = '#dc2626';
                currentUserRole = 'logged_out';
            }
            
            // Check if active report ID is set, if not pass null
            const activeData = currentActiveReportId ? getFormData() : null;
            window.updateActionButtons(activeData);
        };

        onAuthStateChanged(window.auth, (user) => {
            window.updateAuthUI(user);
        });
        
        window.cloudSaveReport = async (data, docId) => {
            if (!window.auth.currentUser) throw new Error("User not logged in.");
            const record = {
                ...data, 
                timestamp: data.timestamp || new Date().toISOString(), // Preserve original timestamp if exists
                savedBy: window.auth.currentUser.email,
                updatedAt: new Date().toISOString(), 
                status: data.status || 'Running' 
            };
             await setDoc(doc(window.db, 'job_cards', docId), record); 
        };
        
        window.cloudLoadReports = async (queryTerm = '', statusFilter = 'Running') => {
            if (!window.auth.currentUser) return [];
            const reports = [];
            let qRef = collection(window.db, 'job_cards');
            
            let q = query(qRef, where("status", "==", statusFilter));

            const querySnapshot = await getDocs(q);
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                data.uniqueId = doc.id; 
                
                const searchString = `${data.challan} ${data.batchNo} ${data.customerName} ${data.partDesc} ${data.uniqueId}`.toLowerCase();
                if (!queryTerm || searchString.includes(queryTerm.toLowerCase())) {
                    reports.push(data);
                }
            });

            // reports ‡§ï‡•ã updatedAt ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§õ‡§æ‡§Å‡§ü‡•á‡§Ç (‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§™‡§π‡§≤‡•á)
            return reports.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        };

        window.cloudDeleteReport = async (docId) => {
            if (!window.auth.currentUser) throw new Error("User not logged in.");
            // üõë RBAC REMOVED: Any logged-in user can delete
            await deleteDoc(doc(window.db, 'job_cards', docId));
        };

        // --- NEW VIEW SWITCHING LOGIC (UNCHANGED) ---
        function showView(view) {
            const homePanel = document.getElementById('homePanel');
            const formPanel = document.querySelector('.form');
            const previewPanel = document.querySelector('.preview-wrap');
            const homeViewBtn = document.getElementById('homeViewBtn');
            const formViewBtn = document.getElementById('formViewBtn');
        
            currentView = view;
            
            if (view === 'home') {
                homePanel.style.display = 'flex';
                formPanel.style.display = 'none';
                previewPanel.style.display = 'none';
                homeViewBtn.style.display = 'none';
                formViewBtn.style.display = 'block';
                if (window.auth.currentUser) {
                    window.loadReportsList('', 'Running'); 
                    window.loadReportsList('', 'Completed'); 
                }
            } else { 
                formPanel.style.display = 'block';
                previewPanel.style.display = 'flex';
                homePanel.style.display = 'none';
                homeViewBtn.style.display = 'block';
                formViewBtn.style.display = 'none';
            }
        }
        window.showView = showView; 
        
    </script>
    
  <style>
    /* ------------------- STYLES: UPDATED FOR 5MM/18MM HEIGHT ------------------- */
    body { font-family: Arial, sans-serif; margin: 12px; background:#f5f5f5; font-size: 14px; }
    .container { display: flex; gap: 12px; min-height: 85vh; }
    .panel { background: white; padding: 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .form { width: 36%; max-width:420px; overflow-y:auto; height:85vh; flex-shrink: 0; } 
    .preview-wrap { width: 64%; display:flex; flex-direction:column; gap:8px; align-items:center; flex-grow: 1; min-width: 300px; }
    .preview { 
        width:100%; 
        max-width:210mm; 
        height: auto; 
        min-height: 297mm; 
        background:white; 
        box-shadow:0 2px 8px rgba(0,0,0,.12); 
        padding:12mm; 
        box-sizing:border-box; 
        overflow-x: auto; 
        font-size: 10px; 
    } 
    h2 { text-align:center; margin:0 0 8px 0; font-size:18px; }
    label { display:block; font-size:13px; margin-top:8px; }
    input[type="text"], input[type="date"], input[type="email"], select { width:100%; padding:6px 8px; margin-top:4px; box-sizing:border-box; border: 1px solid #ccc; border-radius: 4px; }
    .top-grid { display:flex; gap:8px; }
    .top-grid > div { flex:1; }
    .actions { display:flex; gap:8px; margin-top:8px; }
    button { padding:8px 10px; border: none; background:#2563eb; color:white; border-radius:6px; cursor:pointer; font-size: 14px;}
    button.secondary { background:#6b7280; }
    button.delete-btn { background:#dc2626; } 
    button.pdf-btn { background:#f97316; }
    button.print-btn { background:#059669; }
    button:disabled { background:#9ca3af; cursor: not-allowed; }
    .note { font-size:12px; color:#666; margin-top:8px; }
    
    table { 
        width:100%; 
        border-collapse: collapse; 
        table-layout: fixed; 
    }
    table th, table td { 
        border:1px solid #444; 
        padding: 4px 6px; 
        text-align:left; 
        vertical-align:top; 
        line-height: 1.4; 
    } 
    
    /* Column 4 (Observation) should be smaller now */
    #pvTable td:nth-child(5) { 
        font-size: 9px; 
        line-height: 1.2;
    }

    .rows-input { 
        margin-top:8px; 
        border:1px solid #ddd; 
        padding:6px; 
        border-radius:6px; 
        background: #fcfcfc; 
    }
    
    .row-group { border: 1px solid #eee; padding: 8px; margin-bottom: 10px; border-radius: 4px; background: #fff; }
    .row-header { font-weight: bold; margin-bottom: 6px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 4px; border-radius: 4px; }
    .row-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
    .observation-fields { 
        border-top: 1px dashed #ddd; 
        padding-top: 8px; 
        margin-top: 8px; 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 6px; 
    } 
    .report-search-section { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
    .search-area { display: flex; gap: 8px; margin-bottom: 8px; }
    .report-list-container { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; }
    
    /* --- New Styles for Customer/Month Grouping in Home View --- */
    .customer-group, .month-group {
        border: 1px solid #e5e7eb; /* light gray border */
        margin-bottom: 10px;
        border-radius: 6px;
        overflow: hidden;
    }
    .customer-header, .month-header {
        background: #f3f4f6; /* very light gray background */
        padding: 8px 10px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
        font-size: 14px;
        color: #1f2937;
        user-select: none; /* Prevent text selection on click */
    }
    .month-header {
        background: #f9fafb; /* slightly lighter for month */
        padding-left: 20px;
        font-size: 13px;
    }
    .customer-header:hover, .month-header:hover {
        background: #e5e7eb;
    }
    .report-list-item {
        padding: 6px 15px 6px 30px; /* Indentation for item */
        border-bottom: 1px dashed #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
        font-size: 13px;
        background: white;
    }
    .report-list-item:hover {
        background: #f7f7f7;
    }
    .report-list-item.selected { 
        background: #dbeafe; 
        font-weight: bold; 
        border-left: 3px solid #2563eb; 
        padding-left: 27px;
    }
    .folder-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .folder-content.expanded {
        max-height: 2000px; /* Enough height for expansion */
        transition: max-height 0.5s ease-in;
    }
    /* Arrow rotation for folder icon */
    .toggle-icon {
        transition: transform 0.3s;
    }
    .toggle-icon.expanded {
        transform: rotate(90deg);
    }
    /* Hide the original list item styles (in case of conflict) */
    .report-item {
        display: none !important;
    }
    
    /* End of New Styles for Customer/Month Grouping */


    .full-width-grid { grid-template-columns: 1fr; } 
    .operator-supervisor-grid { 
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 6px; 
        border-top: 1px dashed #ddd; 
        padding-top: 8px; 
        margin-top: 8px; 
    }
    .auth-bar {
        background-color: #f0f8ff;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 12px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
    }
    .auth-bar input { padding: 4px 6px; border: 1px solid #999; border-radius: 3px; margin-right: 5px; width: 140px; }
    .auth-bar button { padding: 4px 8px; margin-left: 5px; cursor: pointer; border: none; border-radius: 3px; font-weight: bold; font-size: 13px; }
    .auth-status-text { font-weight: bold; margin-right: 10px; font-size: 14px; }
    .auth-controls { display: flex; align-items: center; flex-wrap: wrap; }
    
    .inspection-codes-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr; 
        gap: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .inspection-codes-grid > div {
        text-align: center;
        border: 1px solid #ccc;
        padding: 5px;
        font-size: 10px;
        line-height: 1;
        background: #fcfcfc;
    }
    
    .hide-inspection { display: none; } 
    
    @media (max-width: 900px) {
        .container { flex-direction: column; }
        .form { width: 100%; max-width: none; height: auto; order: 1; }
        .preview-wrap { width: 100%; order: 2; align-items: stretch; }
        .preview { min-height: 200px; padding: 5px; box-shadow: none; overflow-x: auto; }
        .preview table { min-width: 1000px; } 
        .auth-bar { flex-direction: column; align-items: stretch; }
        .auth-controls { justify-content: center; margin-top: 8px; }
        .auth-bar input { width: calc(50% - 10px); margin: 5px; }
        .auth-bar button { width: auto; margin: 5px; }
        
        #homePanel { height: auto !important; }
    }
    @media print {
        body * { visibility: hidden; }
        .preview, .preview * { visibility: visible; }
        .preview { 
            position: absolute; 
            left:0; 
            top:0; 
            box-shadow:none; 
            width: 210mm; 
            height: auto; 
            padding: 12mm; 
            margin: 0; 
            overflow: hidden; 
            font-size: 9.5px; 
        }
        .preview table { min-width: 100%; }
        .preview table th, .preview table td { 
            padding: 4px 5px; 
            line-height: 1.4; 
        } 
        /* Ensure Observation column has appropriate styles if needed */
        #pvTable td:nth-child(5) { font-size: 9px; } 
    }
  </style>
</head>
<body>
    
  <div class="auth-bar">
    <div id="loggedOutUI" class="auth-controls">
        <span class="auth-status-text" id="authStatus" style="color: #dc2626;">Status: Logged Out (Cloud Disabled)</span>
        <input type="email" id="loginEmail" placeholder="Email" value="test@jobcard.com">
        <input type="password" id="loginPassword" placeholder="Password" value="password123">
        <button id="loginButton" style="background-color: #3f51b5; color: white;" onclick="handleAuthAction('signin')">Sign In</button>
        <button id="signUpButton" style="background-color: #059669; color: white;" onclick="handleAuthAction('signup')">Sign Up</button>
    </div>
    
    <div id="loggedInUI" class="auth-controls" style="display: none;">
        <span class="auth-status-text" id="userEmailDisplay" style="color: #059669;"></span>
        <button id="logoutButton" style="background-color: #f97316; color: white;" onclick="handleAuthAction('logout')">Log Out</button>
    </div>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px; flex-wrap: wrap;">
    <h1 style="font-size:18px;margin:0 0 5px 0;">Job Card / Route Card ‚Äî Cloud PWA System (Full Access)</h1>
    <div class="actions" style="width: auto; align-items: center; flex-wrap: wrap;">
      <button id="homeViewBtn" class="secondary" style="background:#5a67d8;">üè† Home / Job Folders</button> 
      <button id="formViewBtn" class="secondary" style="background:#2563eb; display:none;">üìù Go to Job Card Form</button> 
      <span id="currentReportId" style="font-size:14px; color:#666; margin-right: 15px;">Active ID: -- New --</span>
      <button id="downloadPdfBtn" class="pdf-btn">‚¨áÔ∏è Download PDF (Auto Height)</button>
      <button id="printBtn" class="print-btn">üñ®Ô∏è Print Job Card (Screen View)</button>
    </div>
  </div>

  <div class="container">
    
    <div id="homePanel" class="panel" style="width:100%; height:85vh; display: none; flex-direction: column; gap: 15px;">
        <h2 style="font-size: 20px; color:#10b981; margin-bottom: 0;">üìã Job Card Management Home</h2>
        <div style="display: flex; gap: 15px; flex-grow: 1;">
            
            <div style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fffbe6; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color:#f59e0b;">üèÉ Running Jobs (Active)</h3>
                <div class="search-area" style="margin-bottom: 8px;">
                    <input id="runningSearch" type="text" placeholder="Challan / Part / Customer ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç" oninput="loadReportsList(this.value, 'Running')" />
                    <button onclick="loadReportsList(document.getElementById('runningSearch').value, 'Running')">üîç</button>
                </div>
                <div id="runningJobsContainer" class="report-list-container" style="max-height: none; flex-grow: 1; border: none; padding: 0;">
                    <div style="padding:10px; text-align:center; color:#666;">... Loading Running Jobs ...</div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button id="newJobFromHome" style="background:#10b981;">‚ûï Create New Job Card</button>
                </div>
            </div>
            
            <div style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #f0fdf4; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color:#059669;">‚úÖ Completed Jobs (History)</h3>
                <div class="search-area" style="margin-bottom: 8px;">
                    <input id="completedSearch" type="text" placeholder="Challan / Part / Customer ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç" oninput="loadReportsList(this.value, 'Completed')" />
                    <button onclick="loadReportsList(document.getElementById('completedSearch').value, 'Completed')">üîç</button>
                </div>
                <div id="completedJobsContainer" class="report-list-container" style="max-height: none; flex-grow: 1; border: none; padding: 0;">
                    <div style="padding:10px; text-align:center; color:#666;">... Loading Completed Jobs ...</div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel form" style="display: none;">
      
      <div class="report-search-section">
        <h2 style="font-size: 16px; text-align: left; margin-bottom: 8px; color:#2563eb;">Active Job Card</h2>
        
        <div style="display: none;"><label>Job Status</label><input id="statusField" type="text" value="Running" readonly></div>
        
        <div class="report-actions-bottom">
          <button id="newReportBtn" class="secondary" style="background:#10b981;">‚ûï New Job Card</button>
          <button id="saveReport" disabled>üíæ Save New Report</button>
          <button id="completeReportBtn" class="secondary" style="background:#059669;" disabled>‚úÖ Mark as Completed</button> 
          <button id="deleteReport" class="delete-btn" disabled>üóëÔ∏è Delete</button>
        </div>
        <div class="note" style="color: #f97316; font-weight: bold;">üîë Report Customer/Part/Challan No ‡§∏‡•á Save ‡§π‡•ã‡§ó‡•Ä‡•§</div>
        <div class="note" style="color: #dc2626; font-weight: bold;">‚ö†Ô∏è ‡§Ø‡§π ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° (Firebase) ‡§™‡§∞ ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ‡•§</div>
      </div>
      
      <h2 style="margin-top:20px;">General Information</h2>
      <label>Customer Name
        <input id="customerName" type="text" placeholder="Customer name" value="Star Engineering" />
      </label>
      
      <div class="top-grid">
        <div><label>Order/Challan Qty<input id="orderQty" type="text" placeholder="Qty" value="1000 Pcs" /></label></div>
        <div><label>Challan No/Date<input id="challan" type="text" placeholder="No / Date" value="CH/2508/01 | 01.09.2025" /></label></div>
      </div>
      <label>Part Desc / No<input id="partDesc" type="text" placeholder="Part description or no" value="LAC09170" /></label>
      <div class="top-grid">
        <div><label>Coating Spec (e.g. 2B, 1T)</label><input id="coatingSpec" type="text" placeholder="e.g. 1B,2B,1T" value="2 Base | 2 Top"/></div>
        <div>
          <label>**Paint**
            <select id="paint">
                <option value="Silver">Silver</option>
                <option value="Black" selected>Black</option>
            </select>
            <button id="updateOpsBtn" style="width:100%; margin-top:5px; padding: 8px;">Update Operations</button>
          </label>
        </div>
      </div>
      
      <label>**Batch No.**
        <input id="batchNo" type="text" placeholder="Batch number" value="250819" />
      </label>
      
      <h2 style="margin-top:20px;">Coating Batch Numbers & Paint Details</h2>
      <div class="inspection-codes-grid">
          <div id="silverInspDiv" class="hide-inspection"><label>Silver Paint Name</label><input id="silverInsp" type="text" placeholder="Silver Paint Name" value="Silver Paint" /></div>
          <div id="blackInspDiv"><label>Black Paint Name</label><input id="blackInsp" type="text" placeholder="Black Paint Name" value="Black Paint" /></div>
          <div><label>Base Coat Batch No.</label><input id="baseBatch" type="text" placeholder="Base Coat Batch No" value="BCB101" /></div>
          <div><label>Top Coat Batch No.</label><input id="topBatch" type="text" placeholder="Top Coat Batch No" value="TCB202" /></div>
      </div>
      
      <h2 style="margin-top:20px;">Operation Details (Input Fields)</h2>
      <div class="rows-input"><div id="rowsInput"></div></div>
      <div class="note">‡§π‡§∞ ‡§ë‡§™‡§∞‡•á‡§∂‡§® ‡§ï‡•á ‡§®‡•Ä‡§ö‡•á **Observation** ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§≠‡§∞‡•á‡§Ç‡•§</div>
      <h2 style="margin-top:20px;">Signatures & Notes</h2>
      <label>Verified By<input id="verifiedBy" type="text" placeholder="Verified by" value="SAKSHI CHAVHAN" /></label>
      <label>Approved By<input id="approvedBy" type="text" placeholder="Approved by" value="ABHIJEET DHOKRAT" /></label>
      <label>Notes<input id="notes" type="text" placeholder="Notes / Remark" value="P- Pointage, V- Viscosity, T- Temp, S-speed, A-Adhesion." /></label>
      <div class="actions">
        <button id="applyBtn">Apply to Preview</button>
        <button id="clearBtn" class="secondary">Clear Form</button>
      </div>
    </div>

    <div class="preview-wrap" style="display: none;">
      <div class="panel" style="width:100%; padding:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small">ISO 9001:2015</div>
        </div>
      </div>
      <div id="preview" class="preview panel">
        <h2>JOB CARD / ROUTE CARD</h2>
        
        <table style="margin-bottom:8px; table-layout: fixed; width:100%;">
            <tr>
                <td style="width:33.3%; text-align:center;">Format No: **WT/PDR/11**</td>
                <td style="width:33.3%; text-align:center;">REV. NO: **01**</td>
                <td style="width:33.3%; text-align:center;">REV. DATE: **01.09.2025**</td>
            </tr>
        </table>
        
        <table style="margin-bottom:8px; table-layout: auto;">
          <tr><td style="width:18%">Customer Name</td><td id="pvCustomer" style="width:32%"></td><td style="width:18%">Order/Challan Qty</td><td id="pvQty" style="width:32%"></td></tr>
          <tr><td>Customer Challan No/Date</td><td id="pvChallan" colspan="3"></td></tr>
          <tr><td>Part Desc/No</td><td id="pvPart"></td><td>**Batch No.**</td><td id="pvBatchNo"></td></tr>
        </table>

        <table style="margin-bottom:8px; table-layout: auto;">
            <thead>
                <tr>
                    <td style="width:25%">COATING SPECIFICATION</td>
                    <th id="pvInspHeader" style="width:17%; text-align:center;">Paint</th>
                    <th style="width:29%; text-align:center;">BASE COAT BATCH NO.</th>
                    <th style="width:29%; text-align:center;">TOP COAT BATCH NO.</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="pvCoating" style="text-align:center; font-weight:bold;"></td>
                    <td id="pvInspValue" style="text-align:center;"></td>
                    <td id="pvBaseBatch" style="text-align:center;"></td>
                    <td id="pvTopBatch" style="text-align:center;"></td>
                </tr>
            </tbody>
        </table>

        <table id="pvTable">
          <thead>
            <tr>
              <th style="width:4%">Sr No</th>
              <th style="width:10%">Date/Shift</th>
              <th style="width:12%">Operation</th>
              <th style="width:28%">Specifications</th> 
              <th style="width:18%">Observation</th>
              <th style="width:7%">From Time</th>
              <th style="width:7%">To Time</th>
              <th style="width:7%">Inspection OK/NOK</th>
              <th style="width:16%">Operator/Supervisor/QA Signature</th> </tr>
          </thead>
          <tbody id="pvRows"></tbody>
        </table>
        
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <div>Verified By: <span id="pvVerified"></span></div>
          <div>Approved By: <span id="pvApproved"></span></div>
        </div>
        
        <div style="margin-top:6px;">
            Note - <span id="pvNotes"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    let currentActiveReportId = null; 
    // UPDATED: 'customerWhatsapp' removed from jobFields
    const jobFields = ['customerName', 'orderQty','challan','partDesc','coatingSpec','paint','batchNo', 'verifiedBy','approvedBy','notes', 'silverInsp', 'blackInsp', 'baseBatch', 'topBatch'];
    
    // --- SPECIFICATIONS (UNCHANGED) ---
    const SPECIFICATIONS = {
        "Incoming Inspection": "Dent free, no heavy rust or oil, gauge fitment",
        "Alkaline Cleaning": "45-65 gms/litre",
        "Drying": "Temp (100-220¬∞C) & Time(15-30 mins)", 
        "Shot Blasting": "15 to 30 mins", 
        "Packing & Dispatch": "Qty (value), Match Check", 
        "Spare Operation": "N/A",
        "Final Inspection_Silver": "No uncover coating, no excess paint in thread & socket, Adhesion test should be clean. Silver Thickness range - 6 to 12 microns",
        "Final Inspection_Black": "No uncover coating, no excess paint in thread & socket, Adhesion test should be clean. Black Thickness range - 8 to 16 microns",
        "Silver_Base Coat -1 & Curing": "Geopert: Viscosity - 90 to 120 sec, curing temp - 360¬∞C, speed - 5 Hz.",
        "Silver_Base Coat -2 & Curing": "Geopert: Viscosity - 90 to 120 sec, curing temp - 360¬∞C, speed - 5 Hz.",
        "Silver_Top Coat -1 & Curing": "Aquazinc: Viscosity - 28 to 38 sec, curing temp - 180¬∞C, time - 30 mins.", 
        "Silver_Top Coat -2 & Curing": "N/A", 
        "Black_Base Coat -1 & Curing": "Zintek: Viscosity -42-53 sec, curing temp - 280¬∞C, speed - 3.38 Hz.",
        "Black_Base Coat -2 & Curing": "Zintek: Viscosity -42-53 sec, curing temp - 280¬∞C, speed - 3.38 Hz.",
        "Black_Top Coat -1 & Curing": "Techdip: Viscosity -42-50 sec, curing temp - 260¬∞C, speed - 3.38 Hz.",
        "Black_Top Coat -2 & Curing": "Techdip: Viscosity -42-50 sec, curing temp - 260¬∞C, speed - 3.38 Hz.",
    };
    
    // --- PARAMETERS (UNCHANGED) ---
    const PARAMETERS = {
        "Incoming Inspection": { labels: ["Observation"], units: [""] }, 
        "Alkaline Cleaning": { labels: ["Pointage"], units: ["gms/litre"] }, 
        "Drying": { labels: ["Temp", "Time"], units: ["¬∞C", "min"] }, 
        "Shot Blasting": { labels: ["Time"], units: ["min"] },
        "Base Coat -1 & Curing": { labels: ["Viscosity", "Temp", "Curing", "Speed"], units: ["sec", "¬∞C", "", "Hz"], isCoating: true },
        "Base Coat -2 & Curing": { labels: ["Viscosity", "Temp", "Curing", "Speed"], units: ["sec", "¬∞C", "", "Hz"], isCoating: true },
        "Top Coat -1 & Curing": { labels: ["Viscosity", "Temp", "Curing", "Time/Speed"], units: ["sec", "¬∞C", "", "min/Hz"], isCoating: true },
        "Top Coat -2 & Curing": { labels: ["Viscosity", "Temp", "Curing", "Time/Speed"], units: ["sec", "¬∞C", "", "min/Hz"], isCoating: true },
        "Final Inspection": { labels: ["Thickness", "Adhesion"], units: ["microns", ""] },
        "Packing & Dispatch": { labels: ["Qty", "Match"], units: [""] },
        "Spare Operation": { labels: ["N/A"], units: [""] },
    };
    
    const BASE_OPERATIONS = [
      { op: "Incoming Inspection", color: 'N/A' },
      { op: "Alkaline Cleaning", color: 'N/A' },
      { op: "Drying", color: 'N/A' },
      { op: "Shot Blasting", color: 'N/A' },
      { op: "Final Inspection", color: 'N/A' },
      { op: "Packing & Dispatch", color: 'N/A' },
      { op: "Spare Operation", color: 'N/A' }, 
    ];
    
    // --- Core Logic Functions - getCurrentPredefinedOperations (UNCHANGED) ---
    function getCurrentPredefinedOperations() {
        const paintSelect = document.getElementById('paint');
        const paintType = paintSelect.value;
        const ops = JSON.parse(JSON.stringify(BASE_OPERATIONS)); 
        const coatingSteps = [];

        const silverDiv = document.getElementById('silverInspDiv');
        const blackDiv = document.getElementById('blackInspDiv');
        
        silverDiv.classList.add('hide-inspection');
        blackDiv.classList.add('hide-inspection');
        
        let requiredLength = 10; 
        
        if (paintType === 'Black') {
            document.getElementById('coatingSpec').value = "2 Base | 2 Top";
            blackDiv.classList.remove('hide-inspection');
            coatingSteps.push(
                { op: "Base Coat -1 & Curing", color: 'Black' },
                { op: "Base Coat -2 & Curing", color: 'Black' },
                { op: "Top Coat -1 & Curing", color: 'Black' },
                { op: "Top Coat -2 & Curing", color: 'Black' }
            );
             requiredLength = 10; 
        } else if (paintType === 'Silver') {
             document.getElementById('coatingSpec').value = "2 Base | 1 Top";
             silverDiv.classList.remove('hide-inspection');
             coatingSteps.push(
                { op: "Base Coat -1 & Curing", color: 'Silver' },
                { op: "Base Coat -2 & Curing", color: 'Silver' },
                { op: "Top Coat -1 & Curing", color: 'Silver' }
            );
            requiredLength = 9; 
        } else {
             document.getElementById('coatingSpec').value = "2 Base | 2 Top";
             blackDiv.classList.remove('hide-inspection');
             coatingSteps.push(
                { op: "Base Coat -1 & Curing", color: 'Black' },
                { op: "Base Coat -2 & Curing", color: 'Black' },
                { op: "Top Coat -1 & Curing", color: 'Black' },
                { op: "Top Coat -2 & Curing", color: 'Black' }
            );
            requiredLength = 10;
        }

        const finalInspectionIndex = ops.findIndex(op => op.op === 'Final Inspection');
        ops.splice(finalInspectionIndex, 0, ...coatingSteps);
        
        while (ops.length > requiredLength) {
             ops.pop();
        }
        
        while (ops.length < requiredLength) { 
            ops.push({ op: "Spare Operation", color: 'N/A' }); 
        }

        return ops; 
    }

    // --- updateRowInputs (UPDATED: QTY field removed) ---
    function updateRowInputs(savedRows = []) {
        const predefinedOperations = getCurrentPredefinedOperations();
        const rowsInputContainer = document.getElementById('rowsInput');
        rowsInputContainer.innerHTML = ''; 
        
        const mapSavedData = (rows) => {
            const dataMap = {};
            rows.forEach(r => {
                const opParams = PARAMETERS[r.operation] || { labels: [], units: [] };
                const values = (r.observation || '').split(';').map(v => v.trim()); 
                const obsValues = {};
                
                opParams.labels.forEach((label, j) => {
                    const inputName = label.replace(/[^a-zA-Z0-9]/g, '');
                    obsValues[inputName] = values[j] || '';
                });
                dataMap[r.operation] = { 
                    ...r, 
                    obsValues, 
                    inspectionStatus: r.inspectionStatus || 'N/A',
                    operatorChecked: r.operatorChecked || '', 
                    supervisorSign: r.supervisorSign || ''
                }; 
            });
            return dataMap;
        };

        const savedDataMap = mapSavedData(savedRows);
        
        predefinedOperations.forEach((opConfig, index) => {
            const srCount = index + 1;
            const opName = opConfig.op;
            const opParams = PARAMETERS[opName];
            
            const savedData = savedDataMap[opName] || { obsValues: {}, inspectionStatus: 'N/A', operatorChecked: '', supervisorSign: '' };
            
            const div = document.createElement('div');
            div.dataset.sr = srCount;
            div.dataset.operation = opName;
            div.className = 'row-group';
            
            let obsFieldsHTML = '';
            
            const paintType = document.getElementById('paint').value;
            const specKey = opName.includes('Coat') ? `${paintType}_${opName}` : (opName === 'Final Inspection' ? `${opName}_${paintType}` : opName);
            const specification = SPECIFICATIONS[specKey] || opName;


            opParams.labels.forEach((label, j) => {
                if (label !== "N/A" && label.trim().length > 0) {
                    const unit = opParams.units[j];
                    const inputName = label.replace(/[^a-zA-Z0-9]/g, ''); 
                    const placeholder = `${label} ${unit ? '(' + unit + ')' : ''}`;
                    const savedValue = savedData.obsValues[inputName] || '';
                    
                    obsFieldsHTML += `
                        <div>
                            <label>${placeholder}</label>
                            <input data-field="obsParam" data-param="${inputName}" type="text" placeholder="${placeholder}" value="${savedValue}" />
                        </div>
                    `;
                }
            });
            
            obsFieldsHTML += `
                <div>
                    <label>Inspection OK/NOK</label>
                    <select data-field="inspectionStatus">
                        <option value="N/A" ${savedData.inspectionStatus === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="OK" ${savedData.inspectionStatus === 'OK' ? 'selected' : ''}>OK</option>
                        <option value="NOK" ${savedData.inspectionStatus === 'NOK' ? 'selected' : ''}>NOK</option>
                    </select>
                </div>
            `;
            
            div.innerHTML = `
                <div class="row-header">
                    <span>${srCount}. ${opName}</span>
                    <span>Spec: ${specification.substring(0, 40) + (specification.length > 40 ? '...' : '')}</span>
                </div>
                <div class="row-detail-grid">
                    <div>
                        <label>Date/Shift</label>
                        <input data-field="dateShift" type="text" placeholder="Date/Shift" value="${savedData.dateShift || ''}" />
                    </div>
                    <div>&nbsp;</div>
                </div>
                <div class="row-detail-grid">
                    <div><label>From Time</label><input data-field="fromTime" type="text" placeholder="From T." value="${savedData.fromTime || ''}" /></div>
                    <div><label>To Time</label><input data-field="toTime" type="text" placeholder="To T." value="${savedData.toTime || ''}" /></div>
                </div>

                <div class="observation-fields">
                    ${obsFieldsHTML}
                </div>
                
                <div class="operator-supervisor-grid">
                    <div>
                        <label>Signature Input (Operator/Supervisor/QA)</label>
                        <input data-field="supervisorSign" type="text" placeholder="Operator Name / QA Name / Sign" value="${savedData.supervisorSign || ''}" />
                    </div>
                </div>
            `;
            
            div.querySelectorAll('input, select').forEach(inp => { 
                inp.addEventListener('change', applyPreview);
                inp.addEventListener('input', applyPreview); 
            });
            
            rowsInputContainer.appendChild(div);
        });
        
        applyPreview(); 
    }

    // --- getFormData (UPDATED: 'customerWhatsapp' removed and QTY saving logic removed) ---
    function getFormData() {
      const data = {};
      jobFields.forEach(f=> data[f] = document.getElementById(f).value.trim());
      
      data.status = document.getElementById('statusField')?.value || 'Running'; 
      
      const cleanCustomer = data.customerName.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      const cleanPart = data.partDesc.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      const cleanChallan = data.challan.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      
      data.uniqueId = currentActiveReportId; // FIX: Use currentActiveReportId if set
      
      // If currentActiveReportId is null or a temporary NEW_ one, generate a stable uniqueId
      if (!data.uniqueId || data.uniqueId.startsWith('NEW_')) {
          data.uniqueId = `${cleanCustomer.substring(0, 3)}_${cleanPart}_${cleanChallan}`;
          if(data.uniqueId.length < 5 || data.uniqueId.length > 50 || data.uniqueId.endsWith('__')) {
               data.uniqueId = `NEW_${Date.now()}`;
          }
          data.uniqueId = data.uniqueId.toUpperCase();
      }
      
      
      const rows = [];
      document.getElementById('rowsInput').querySelectorAll('.row-group').forEach((group, index)=>{
        const operation = group.dataset.operation || '';
        const opParams = PARAMETERS[operation];
        
        let observationValues = [];
        
        opParams.labels.forEach((label) => {
            if (label !== "N/A" && label.trim().length > 0) {
                const inputName = label.replace(/[^a-zA-Z0-9]/g, '');
                const inputElement = group.querySelector(`input[data-field="obsParam"][data-param="${inputName}"]`);
                observationValues.push(inputElement?.value.trim() || '');
            }
        });
        
        const observation = observationValues.join('; ').trim(); 

        const dateShiftValue = group.querySelector('input[data-field="dateShift"]').value.trim();
        if (operation.includes('Spare Operation') && observation.replace(/; /g, '').length === 0 && dateShiftValue === '') return;
        
        rows.push({
          sr: index + 1,
          dateShift: group.querySelector('input[data-field="dateShift"]').value.trim(),
          observation: observation, 
          fromTime: group.querySelector('input[data-field="fromTime"]').value.trim(),
          toTime: group.querySelector('input[data-field="toTime"]').value.trim(),
          qty: '', // Qty field removed, saving as empty string to maintain schema if needed
          inspectionStatus: group.querySelector('select[data-field="inspectionStatus"]').value, 
          operatorChecked: '', 
          supervisorSign: group.querySelector('input[data-field="supervisorSign"]').value.trim(), 
          operation: operation, 
        });
      });
      data.rows = rows;
      
      return data;
    }

    // --- Utility Functions (UPDATED: 'customerWhatsapp' removed from clearForm) ---

    function setFormData(data) {
        jobFields.forEach(f => {
            const el = document.getElementById(f);
            if (el && data[f] !== undefined) {
                 el.value = data[f] || ''; 
            }
        });
        
        const statusEl = document.getElementById('statusField');
        if (statusEl) {
            const currentStatus = data.status || 'Running';
            statusEl.value = currentStatus;
            document.getElementById('completeReportBtn').textContent = (currentStatus === 'Completed') ? '‚úÖ Job is Completed' : '‚úÖ Mark as Completed';
        }


        // FIX: Set currentActiveReportId to the loaded unique ID
        currentActiveReportId = data.uniqueId || null; 
        document.getElementById('currentReportId').textContent = `Active ID: ${currentActiveReportId && !currentActiveReportId.startsWith('NEW') ? currentActiveReportId : '-- New --'}`;
        
        // The display text will be handled by updateActionButtons
        // document.getElementById('saveReport').textContent = currentActiveReportId && currentActiveReportId.startsWith('NEW') ? 'üíæ Save New Report' : 'üíæ Update Report';
        
        updateRowInputs(data.rows || []); 
        window.updateActionButtons(data); // Using global function
    }

    function clearForm() {
        jobFields.forEach(f => {
            const el = document.getElementById(f);
            if (el && (el.type === 'text' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.type === 'email')) {
                 el.value = ''; 
            } else if (el && el.tagName === 'SELECT') {
                 el.value = el.options[0].value;
            }
        });
        
        // Resetting default values
        document.getElementById('customerName').value = "Star Engineering";
        // REMOVED: document.getElementById('customerWhatsapp').value = "+919999999999";
        document.getElementById('orderQty').value = "1000 Pcs";
        document.getElementById('challan').value = "CH/2508/01 | 01.09.2025";
        document.getElementById('batchNo').value = "250819"; 
        document.getElementById('verifiedBy').value = "SAKSHI CHAVHAN";
        document.getElementById('approvedBy').value = "ABHIJEET DHOKRAT";
        document.getElementById('notes').value = "P- Pointage, V- Viscosity, T- Temp, S-speed, A-Adhesion.";
        document.getElementById('paint').value = 'Black'; 
        document.getElementById('silverInsp').value = 'Silver Paint';
        document.getElementById('blackInsp').value = 'Black Paint';
        document.getElementById('baseBatch').value = 'BCB101';
        document.getElementById('topBatch').value = 'TCB202';
        
        const statusEl = document.getElementById('statusField');
        if (statusEl) statusEl.value = 'Running';
        document.getElementById('completeReportBtn').textContent = '‚úÖ Mark as Completed';
        document.getElementById('completeReportBtn').disabled = true;

        currentActiveReportId = null;
        document.getElementById('currentReportId').textContent = `Active ID: -- New --`;
        document.getElementById('saveReport').textContent = 'üíæ Save New Report';
        document.getElementById('deleteReport').disabled = true;
        // document.getElementById('sendReportBtn').disabled = true; // REMOVED

        updateRowInputs(); 
        applyPreview();
        window.updateActionButtons(null); // Using global function
    }
    
    // --- CLOUD LOGIC FUNCTIONS (UNCHANGED) ---

    async function handleSaveReport() {
        if (!window.auth.currentUser) {
            alert("‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§");
            return;
        }
        
        const data = getFormData();
        
        if (!data.challan || !data.customerName) {
            alert("‚ùå ‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§î‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§");
            return;
        }

        try {
            await window.cloudSaveReport(data, data.uniqueId);
            
            // FIX: Set currentActiveReportId to the ID that was successfully saved
            currentActiveReportId = data.uniqueId;
            document.getElementById('currentReportId').textContent = `Active ID: ${currentActiveReportId}`;
            
            // Set the saved data back to the form so updateActionButtons can work correctly
            setFormData(data); 
            
            alert(`‚úÖ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§™‡§∞ ‡§∏‡•á‡§µ/‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§ ID: ${currentActiveReportId}`);
            
            // Reload lists to show updated data and grouping
            window.loadReportsList('', 'Running'); 
            window.loadReportsList('', 'Completed'); 
            
        } catch (e) {
            console.error(e);
            alert(`‚ùå ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}`);
        }
    }

    async function handleDeleteReport() {
        if (!currentActiveReportId || currentActiveReportId.startsWith('NEW')) {
            alert("‚ùå ‡§Ø‡§π ‡§è‡§ï ‡§®‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•à, ‡§á‡§∏‡•á ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ‡•§");
            return;
        }
        
        // üõë RBAC REMOVED: No more Admin check here, only check for logged in is in cloudDeleteReport
        if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ID ${currentActiveReportId} ‡§ï‡•ã ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
            return;
        }
        
        try {
            await window.cloudDeleteReport(currentActiveReportId);
            alert(`‚úÖ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ID ${currentActiveReportId} ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§`);
            clearForm();
            window.loadReportsList('', 'Running'); 
            window.loadReportsList('', 'Completed');
        } catch (e) {
            console.error(e);
            alert(`‚ùå ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}`);
        }
    }
    
    // --- UPDATED: loadReportsList (UNCHANGED) ---
    window.loadReportsList = async (query = '', statusFilter = 'Running') => {
        try {
            const reports = await window.cloudLoadReports(query, statusFilter);
            
            const containerId = (statusFilter === 'Running') ? 'runningJobsContainer' : 'completedJobsContainer';
            const container = document.getElementById(containerId);
            
            container.innerHTML = '';
            
            if (reports.length === 0) {
                 container.innerHTML = '<div style="padding:10px; text-align:center; color:#666;">‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</div>';
                 return;
            }
            
            // --- 1. Grouping Logic: Customer-wise and then Month-wise ---
            const groupedReports = {}; // { customerName: { monthYear: [reports] } }
            const monthNames = ["‡§ú‡§®‡§µ‡§∞‡•Ä", "‡§´‡§∞‡§µ‡§∞‡•Ä", "‡§Æ‡§æ‡§∞‡•ç‡§ö", "‡§Ö‡§™‡•ç‡§∞‡•à‡§≤", "‡§Æ‡§à", "‡§ú‡•Ç‡§®", "‡§ú‡•Å‡§≤‡§æ‡§à", "‡§Ö‡§ó‡§∏‡•ç‡§§", "‡§∏‡§ø‡§§‡§Æ‡•ç‡§¨‡§∞", "‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞", "‡§®‡§µ‡§Æ‡•ç‡§¨‡§∞", "‡§¶‡§ø‡§∏‡§Æ‡•ç‡§¨‡§∞"];
            
            reports.forEach(report => {
                // Determine the correct date for sorting/grouping (updatedAt is preferred)
                const date = new Date(report.updatedAt || report.timestamp);
                
                // Construct MonthYear Key (e.g., "‡§ú‡§®‡§µ‡§∞‡•Ä 2025")
                const monthYearKey = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                
                // Construct Customer Key
                const customerKey = report.customerName.trim() || 'No Customer Name';
                
                if (!groupedReports[customerKey]) {
                    groupedReports[customerKey] = {};
                }
                if (!groupedReports[customerKey][monthYearKey]) {
                    groupedReports[customerKey][monthYearKey] = [];
                }
                groupedReports[customerKey][monthYearKey].push(report);
            });
            
            // --- 2. Rendering the Grouped Structure ---
            for (const customerName in groupedReports) {
                const customerGroupDiv = document.createElement('div');
                customerGroupDiv.className = 'customer-group';
                
                const customerHeader = document.createElement('div');
                customerHeader.className = 'customer-header';
                
                // Calculate total jobs for this customer
                let totalJobs = 0;
                for(const month in groupedReports[customerName]) {
                    totalJobs += groupedReports[customerName][month].length;
                }
                
                customerHeader.innerHTML = `${customerName} <span style="font-size: 11px; margin-left: 10px; font-weight: normal; color: #4b5563;">(${totalJobs} Jobs Total)</span> <span class="toggle-icon">‚ñ∂</span>`;
                customerGroupDiv.appendChild(customerHeader);

                const customerContent = document.createElement('div');
                customerContent.className = 'folder-content'; 
                customerGroupDiv.appendChild(customerContent);
                
                // Toggle logic for Customer Folder
                customerHeader.addEventListener('click', () => {
                    customerContent.classList.toggle('expanded');
                    customerHeader.querySelector('.toggle-icon').classList.toggle('expanded');
                });
                
                // Sort months from newest to oldest
                const sortedMonths = Object.keys(groupedReports[customerName]).sort((a, b) => {
                     // Convert month/year string back to a comparable date object
                     const dateA = new Date(a.replace(/(\w+)\s(\d+)/, '$1 1, $2'));
                     const dateB = new Date(b.replace(/(\w+)\s(\d+)/, '$1 1, $2'));
                     return dateB - dateA; // Newest first
                });


                for (const monthYearKey of sortedMonths) {
                    const monthGroupDiv = document.createElement('div');
                    monthGroupDiv.className = 'month-group';
                    
                    const monthHeader = document.createElement('div');
                    monthHeader.className = 'month-header';
                    monthHeader.innerHTML = `${monthYearKey} (${groupedReports[customerName][monthYearKey].length} Jobs) <span class="toggle-icon">‚ñ∂</span>`;
                    customerContent.appendChild(monthHeader);
                    
                    const monthContent = document.createElement('div');
                    monthContent.className = 'folder-content'; 
                    customerContent.appendChild(monthContent);
                    
                    // Toggle logic for Month Folder
                    monthHeader.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the parent Customer folder from closing
                        monthContent.classList.toggle('expanded');
                        monthHeader.querySelector('.toggle-icon').classList.toggle('expanded');
                    });
                    
                    // Render individual reports (sorted newest first by cloudLoadReports)
                    groupedReports[customerName][monthYearKey].forEach(report => {
                        const item = document.createElement('div');
                        item.className = 'report-list-item';
                        if (report.uniqueId === currentActiveReportId) {
                             item.classList.add('selected');
                        }
                        item.dataset.id = report.uniqueId;
                        item.innerHTML = `
                            <span>${report.partDesc} <span style="font-weight: normal; color:#6b7280; margin-left: 8px;">(Batch: ${report.batchNo})</span></span>
                            <span style="font-size:10px; color:#666;">${report.challan}</span>
                        `;
                        item.addEventListener('click', () => {
                            handleLoadReport(report);
                            showView('form'); 
                        });
                        monthContent.appendChild(item);
                    });
                }
                container.appendChild(customerGroupDiv);
                
                // Optionally expand the first customer/month group by default
                // if (container.children.length === 1) {
                //     customerContent.classList.add('expanded');
                //     customerHeader.querySelector('.toggle-icon').classList.add('expanded');
                // }
            }
        } catch (e) {
            console.error(`Error loading ${statusFilter} reports:`, e);
            const containerId = (statusFilter === 'Running') ? 'runningJobsContainer' : 'completedJobsContainer';
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = `<div style="padding:10px; text-align:center; color:red;">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
        }
    };


    function handleLoadReport(reportData) {
        setFormData(reportData);
        
        // Remove 'selected' class from all report items
        document.querySelectorAll('.report-list-item').forEach(item => item.classList.remove('selected'));
        
        // Add 'selected' class to the newly loaded report item
        const selectedItem = document.querySelector(`.report-list-item[data-id="${reportData.uniqueId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
            
            // Ensure the parent folders are expanded when the item is loaded
            let currentParent = selectedItem.closest('.folder-content');
            while(currentParent) {
                currentParent.classList.add('expanded');
                const header = currentParent.previousElementSibling;
                if(header && header.querySelector('.toggle-icon')) {
                    header.querySelector('.toggle-icon').classList.add('expanded');
                }
                currentParent = currentParent.closest('.folder-content:not(.month-group .folder-content)');
                if (currentParent && currentParent.classList.contains('customer-group')) break;
                if (currentParent === selectedItem.closest('.customer-group .folder-content')) currentParent = null; 
            }
        }
    }
    
    // --- Mark Job as Completed (FIXED: Save data before attempting to mark as completed) ---
    async function handleCompleteReport() {
        if (!currentActiveReportId || currentActiveReportId.startsWith('NEW')) {
            alert("‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§≤‡•ã‡§°/‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ Completed ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç‡•§");
            return;
        }
        
        if (document.getElementById('statusField').value === 'Completed') {
            alert("‚ùå ‡§Ø‡§π ‡§ú‡•â‡§¨ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä Completed ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§π‡•à‡•§");
            return;
        }
        
        // FIX: Save the current form data first to ensure it's up-to-date and in the database
        try {
            const dataToComplete = getFormData();
            await window.cloudSaveReport(dataToComplete, dataToComplete.uniqueId);
            
            if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ID ${currentActiveReportId} ‡§ï‡•ã 'Completed' ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? (‡§Ø‡§π 'Completed Jobs' ‡§´‡•ã‡§≤‡•ç‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä)`)) {
                return;
            }
            
            // Now, mark as completed and save again
            dataToComplete.status = 'Completed'; 
            
            await window.cloudSaveReport(dataToComplete, dataToComplete.uniqueId);
            
            // Update UI elements
            document.getElementById('statusField').value = 'Completed';
            document.getElementById('completeReportBtn').textContent = '‚úÖ Job is Completed';
            
            alert(`‚úÖ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ID ${currentActiveReportId} ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï 'Completed' ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§`);
            
            // Reload lists and update buttons with the completed status data
            window.loadReportsList('', 'Running'); 
            window.loadReportsList('', 'Completed'); 
            window.updateActionButtons(dataToComplete); 
            
        } catch (e) {
            console.error(e);
            alert(`‚ùå ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã 'Completed' ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§Ø‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}`);
        }
    }

    // --- REMOVED: Dummy Function for Send Report ---
    /*
    function handleSendReport() {
        if (!currentActiveReportId || currentActiveReportId.startsWith('NEW')) {
            alert("‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§≤‡•ã‡§°/‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ ‡§≠‡•á‡§ú‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç‡•§");
            return;
        }

        const data = getFormData();
        const whatsapp = data.customerWhatsapp;
        
        let message = `‚úÖ Report ID ${currentActiveReportId} (Customer: ${data.customerName}) ‡§ï‡•ã ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§\n`;
        
        // Email logic removed
        message += `\n‚ùå ‡§à‡§Æ‡•á‡§≤ ‡§™‡§§‡§æ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§à‡§Æ‡•á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§`;


        if (whatsapp && whatsapp.trim() !== '') {
            message += `\n\nüí¨ WhatsApp: ${whatsapp} ‡§™‡§∞ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß (Backend Required).`;
        } else {
            message += `\n‚ùå WhatsApp ‡§®‡§Ç‡§¨‡§∞ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à, ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§`;
        }

        message += `\n\n--- ‡§Ø‡§π ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü-‡§∏‡§æ‡§á‡§° ‡§≤‡•â‡§ú‡§ø‡§ï ‡§π‡•à, ‡§Ö‡§∏‡§≤‡•Ä ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡•ã Firebase Cloud Functions ‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§∞‡•ç‡§µ‡§∞-‡§∏‡§æ‡§á‡§° ‡§∏‡•á‡§µ‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§`;
        
        alert(message);
    }
    */


    // ------------------------------------------------------------------
    // --- applyPreview (UNCHANGED as QTY column was already removed in original code) ---
    // ------------------------------------------------------------------
    function applyPreview() {
        const data = getFormData();
        const v = (id) => document.getElementById(id)?.value || '';
        const paintType = v('paint'); 
        
        document.getElementById('pvCustomer').textContent = v('customerName');
        document.getElementById('pvQty').textContent = v('orderQty');
        document.getElementById('pvChallan').textContent = v('challan');
        document.getElementById('pvPart').textContent = v('partDesc');
        document.getElementById('pvBatchNo').textContent = v('batchNo');
        
        document.getElementById('pvCoating').textContent = v('coatingSpec');
        
        const pvInspHeader = document.getElementById('pvInspHeader');
        const pvInspValue = document.getElementById('pvInspValue');
        pvInspHeader.textContent = 'Paint'; 
        
        if (paintType === 'Black') {
            pvInspValue.textContent = v('blackInsp'); 
        } else if (paintType === 'Silver') {
            pvInspValue.textContent = v('silverInsp'); 
        } else {
            pvInspValue.textContent = 'N/A';
        }

        document.getElementById('pvBaseBatch').textContent = v('baseBatch'); 
        document.getElementById('pvTopBatch').textContent = v('topBatch'); 
        
        document.getElementById('pvVerified').textContent = v('verifiedBy');
        document.getElementById('pvApproved').textContent = v('approvedBy');
        document.getElementById('pvNotes').innerHTML = v('notes'); 

        const tbody = document.getElementById('pvRows');
        tbody.innerHTML = '';
        
        const allRows = data.rows;
        let globalSr = 1; 
        const requiredLength = (paintType === 'Silver' ? 9 : 10);

        allRows.forEach(r => {
            const values = (r.observation || '').split(';').map(v => v.trim()); 
            const structure = PARAMETERS[r.operation]; 
            let singleObservationString = '';
            
            if(structure && structure.labels) {
                 for (let j = 0; j < structure.labels.length; j++) {
                    const label = structure.labels[j];
                    const unit = structure.units[j] || '';
                    const value = values[j] || ''; 
                    
                    if (label !== "N/A" && label.trim().length > 0 && value.length > 0) {
                        const unitDisplay = (unit && unit.length > 0) ? `${unit}` : '';
                        let obsPrefix = '';
                        
                        if (r.operation === "Incoming Inspection") { obsPrefix = ''; }
                        else if (label.includes('Pointage')) obsPrefix = 'P-';
                        else if (label.includes('Viscosity')) obsPrefix = 'V-';
                        else if (label.includes('Temp') || label.includes('Time')) obsPrefix = 'T-';
                        else if (label.includes('Speed')) obsPrefix = 'S-';
                        else if (label.includes('Adhesion')) obsPrefix = 'A-';
                        else if (label.includes('Thickness')) obsPrefix = 'T-'; 
                        else if (label.includes('Qty')) obsPrefix = 'Q-'; // Qty is saved in row data but not shown in a dedicated column now
                        
                        singleObservationString += `${obsPrefix}${value}${unitDisplay} `; 
                    }
                }
            } else {
                 singleObservationString = r.observation;
            }
           
            const specKey = r.operation.includes('Coat') ? `${paintType}_${r.operation}` : (r.operation === 'Final Inspection' ? `${r.operation}_${paintType}` : r.operation);
            const specification = SPECIFICATIONS[specKey] || r.operation;
            
            const tr = document.createElement('tr');
            const finalObservation = singleObservationString.trim();

            const rowContent = `
                <td style="text-align:center">${globalSr}</td>
                <td>${r.dateShift || ''}</td>
                <td>${r.operation || ''}</td>
                <td>${specification || ''}</td> 
                <td style="font-size: 9px; line-height: 1.2;">${finalObservation}</td>
                <td style="text-align:center">${r.fromTime || ''}</td>
                <td style="text-align:center">${r.toTime || ''}</td>
                <td style="text-align:center; font-weight: bold;">${r.inspectionStatus || ''}</td> 
                <td>${r.supervisorSign || ''}</td> `; // Qty column removed

            tr.innerHTML = rowContent;
            tbody.appendChild(tr);
            
            const rowHeight = (globalSr === 1) ? '5mm' : '18mm';
            tr.style.height = rowHeight; 
            tr.querySelectorAll('td').forEach(td => td.style.height = rowHeight);
            
            globalSr++;
        });
        
        let currentOutputRows = tbody.querySelectorAll('tr').length;
        
        if (currentOutputRows < requiredLength) {
            for (let i = 0; i < requiredLength - currentOutputRows; i++) {
                const tr = document.createElement('tr');
                // Qty column removed, total 9 columns now
                tr.innerHTML = `<td style="text-align:center">${globalSr + i}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`; 
                tbody.appendChild(tr);
                
                const blankSr = globalSr + i;
                const rowHeight = (blankSr === 1) ? '5mm' : '18mm';
                tr.style.height = rowHeight; 
                tr.querySelectorAll('td').forEach(td => td.style.height = rowHeight);
            }
        }
    }
    
    // ------------------------------------------------------------------
    // --- generatePdfWithAutoTable (UNCHANGED as QTY column was already removed in original code) ---
    // ------------------------------------------------------------------
    async function generatePdfWithAutoTable() {
        const data = getFormData();
        const v = (id) => document.getElementById(id)?.value || '';
        const paintType = v('paint'); 
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageHeight = pdf.internal.pageSize.getHeight(); 
        const bottomMargin = 10;
        const availablePageEnd = pageHeight - bottomMargin; 
        let yOffset = 15; 

        // --- Header and Format No. ---
        pdf.setFontSize(14);
        pdf.text("JOB CARD / ROUTE CARD", 105, yOffset, null, null, "center");
        yOffset += 7;

        pdf.setFontSize(6.5); 
        pdf.text(`Format No: WT/PDR/11  |  REV. NO: 01  |  REV. DATE: 01.09.2025`, 105, yOffset, null, null, "center");
        yOffset += 5;
        
        // --- General Info Table ---
        const generalInfo = [
            ["Customer Name", v('customerName'), "Order/Challan Qty", v('orderQty')],
            ["Customer Challan No/Date", v('challan'), "Batch No.", v('batchNo')],
            ["Part Desc/No", v('partDesc'), "Coating Spec", v('coatingSpec')]
        ];

        pdf.autoTable({
            startY: yOffset,
            head: [],
            body: generalInfo,
            theme: 'grid',
            styles: { fontSize: 6.5, cellPadding: 0.8, lineColor: 0, lineWidth: 0.2 },
            columnStyles: { 0: { cellWidth: 30, fontStyle: 'bold' }, 2: { cellWidth: 30, fontStyle: 'bold' } },
            didDrawPage: (data) => { yOffset = data.cursor.y + 3; }
        });

        // --- Coating Batch Table ---
        const coatingInfo = [
            [v('coatingSpec'), paintType === 'Black' ? v('blackInsp') : v('silverInsp'), v('baseBatch'), v('topBatch')]
        ];
        
        pdf.autoTable({
            startY: yOffset,
            head: [['COATING SPECIFICATION', 'Paint', 'BASE COAT BATCH NO.', 'TOP COAT BATCH NO.']],
            body: coatingInfo,
            theme: 'grid',
            styles: { fontSize: 6.5, cellPadding: 0.8, lineColor: 0, lineWidth: 0.2, halign: 'center' },
            headStyles: { fillColor: [200, 200, 200], fontStyle: 'bold', fontSize: 6.5 },
            didDrawPage: (data) => { yOffset = data.cursor.y + 3; }
        });
        
        // --- Main Operations Table ---
        
        const mainHeader = [
            'Sr No', 'Date/Shift', 'Operation', 'Specifications', 'Observation', 
            'From Time', 'To Time', 'Inspection OK/NOK', 'Operator/Supervisor/QA Signature'
        ];
        
        const mainBody = [];
        const allRows = data.rows;
        let globalSr = 1;
        const requiredLength = (paintType === 'Silver' ? 9 : 10);

        allRows.forEach(r => {
            const values = (r.observation || '').split(';').map(v => v.trim()); 
            const structure = PARAMETERS[r.operation]; 
            let finalObservation = ''; 

            if(structure && structure.labels) {
                 for (let j = 0; j < structure.labels.length; j++) {
                    const label = structure.labels[j];
                    const unit = structure.units[j] || '';
                    const value = values[j] || ''; 
                    
                    if (label !== "N/A" && label.trim().length > 0 && value.length > 0) {
                        const unitDisplay = (unit && unit.length > 0) ? `${unit}` : '';
                        let obsPrefix = '';
                        if (r.operation === "Incoming Inspection") { obsPrefix = ''; }
                        else if (label.includes('Pointage')) obsPrefix = 'P-';
                        else if (label.includes('Viscosity')) obsPrefix = 'V-';
                        else if (label.includes('Temp') || label.includes('Time')) obsPrefix = 'T-';
                        else if (label.includes('Speed')) obsPrefix = 'S-';
                        else if (label.includes('Adhesion')) obsPrefix = 'A-';
                        else if (label.includes('Thickness')) obsPrefix = 'T-'; 
                        else if (label.includes('Qty')) obsPrefix = 'Q-';
                        
                        finalObservation += `${obsPrefix}${value}${unitDisplay} `; 
                    }
                }
            } else {
                 finalObservation = r.observation;
            }
            
            const specKey = r.operation.includes('Coat') ? `${paintType}_${r.operation}` : (r.operation === 'Final Inspection' ? `${r.operation}_${paintType}` : r.operation);
            const specification = SPECIFICATIONS[specKey] || r.operation;
            
            mainBody.push([
                globalSr,
                r.dateShift || '',
                r.operation || '',
                specification || '', 
                finalObservation.trim(),
                r.fromTime || '',
                r.toTime || '',
                r.inspectionStatus || '', // Qty column removed
                r.supervisorSign || '' 
            ]);
            globalSr++;
        });
        
        while (mainBody.length < requiredLength) {
            // Qty column removed (was 10th element)
            mainBody.push([globalSr++, '', '', '', '', '', '', '', '']); 
        }
        
        pdf.autoTable({
            startY: yOffset,
            head: [mainHeader],
            body: mainBody,
            theme: 'grid',
            styles: { 
                fontSize: 6.5, 
                cellPadding: 0.8, 
                lineColor: 0, 
                lineWidth: 0.2, 
                valign: 'middle', 
                minCellHeight: 18.0 
            },
            headStyles: { 
                fillColor: [200, 200, 200], 
                fontStyle: 'bold', 
                valign: 'middle', 
                lineWidth: 0.2, 
                lineColor: 0,
                fontSize: 6.5 
            },
            columnStyles: {
                0: { cellWidth: 8, halign: 'center' }, // Sr No (4)
                1: { cellWidth: 15 }, // Date/Shift (10)
                2: { cellWidth: 18 }, // Operation (12)
                3: { cellWidth: 45 }, // Specifications (28) -> Increased
                4: { cellWidth: 32 }, // Observation (18) -> Increased
                5: { cellWidth: 12, halign: 'center' }, // From Time (7) -> Increased
                6: { cellWidth: 12, halign: 'center' }, // To Time (7) -> Increased
                7: { cellWidth: 15, halign: 'center' }, // Inspection OK/NOK (7) -> Increased
                8: { cellWidth: 33 } // Operator/Supervisor/QA Signature (16) -> Increased
                // Total width is now 8+15+18+45+32+12+12+15+33 = 190 mm (A4 width is 210mm)
            },
            didParseCell: (data) => {
                if (data.section === 'body' && data.row.index === 0) {
                     data.cell.styles.minCellHeight = 5.0; 
                } else if (data.section === 'body') {
                     data.cell.styles.minCellHeight = 18.0; 
                }
                
                if (data.section === 'body' && data.column.dataKey === 4 && data.cell.text.length > 1) {
                    data.cell.styles.fontSize = 5.5; 
                }
            },
            didDrawPage: (data) => { yOffset = data.cursor.y + 3; }
        });
        
        // --- Footer ---
        let footerY = Math.max(pdf.autoTable.previous.finalY + 3, availablePageEnd - 10);
        
        pdf.setFontSize(6.5); 
        pdf.text(`Verified By: ${v('verifiedBy')}`, 10, footerY);
        pdf.text(`Approved By: ${v('approvedBy')}`, 200, footerY, null, null, 'right');
        footerY += 4;
        pdf.text(`Note - ${v('notes')}`, 10, footerY);
        
        // Custom Filename Logic
        const custNameClean = v('customerName').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
        const partNoClean = v('partDesc').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 10);
        const challanClean = v('challan').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
        
        const fileName = `JobCard_${custNameClean}_${partNoClean}_${challanClean}.pdf`;
        pdf.save(fileName);
    }

    // --- Event Listeners (UPDATED: handleSendReport listener removed) ---
    document.getElementById('downloadPdfBtn').addEventListener('click', generatePdfWithAutoTable); 
    document.getElementById('printBtn').addEventListener('click', () => {
        applyPreview(); 
        window.print();
    });
    
    document.getElementById('applyBtn').addEventListener('click', applyPreview);
    document.getElementById('clearBtn').addEventListener('click', clearForm);
    document.getElementById('updateOpsBtn').addEventListener('click', () => updateRowInputs(getFormData().rows)); 
    document.getElementById('paint').addEventListener('change', () => updateRowInputs(getFormData().rows)); 

    document.getElementById('saveReport').addEventListener('click', handleSaveReport);
    document.getElementById('deleteReport').addEventListener('click', handleDeleteReport);
    // document.getElementById('sendReportBtn').addEventListener('click', handleSendReport); // REMOVED
    
    document.getElementById('homeViewBtn').addEventListener('click', () => showView('home'));
    document.getElementById('formViewBtn').addEventListener('click', () => showView('form'));
    document.getElementById('newJobFromHome').addEventListener('click', () => {
        clearForm();
        showView('form');
    });
    document.getElementById('completeReportBtn').addEventListener('click', handleCompleteReport); 
    
    document.getElementById('newReportBtn').addEventListener('click', () => {
        clearForm();
        showView('form');
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        clearForm(); 
    });
  </script>
</body>
</html>
